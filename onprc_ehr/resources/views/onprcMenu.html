<script type="text/javascript">

    Ext4.onReady(function(){
        var webpart = <%=webpartContext%>;

        var div = Ext4.get(webpart.wrapperDivId).parent('div');
        if (div)
            div.setStyle('padding', '0px');

        Ext4.QuickTips.init();

        var panel = Ext4.create('Ext.panel.Panel', {
            cls: 'labkey-iconpanel',
            width: 300,
            border: true,
            itemId: 'menuPanel',
            defaults: {
                //bodyStyle: 'padding: 5px;',
                items: [{
                    xtype: 'dataview',
                    overItemCls: 'x4-item-over',
                    trackOver: true,
                    itemSelector: 'div.thumb-wrap',
                    cls: 'labkey-iconpanel',
                    tpl: [
                        '<tpl for=".">',
                            '<div ',
                            '<tpl if="!canRead">data-qtip="You do not have permission to view this page"</tpl>',
                            'style="width: 300px;" class="thumb-wrap thumb-wrap-side">',
                            '<tpl if="url"><a href="{url}"></tpl>',
                                '<span style="font-weight: bold" class="thumb-label-side">{name:htmlEncode}</span>',
                            '<tpl if="url"></a></tpl>',
                            '</div>',
                        '</tpl>',
                        '<div class="x-clear"></div>'
                    ],
                    store: {
                        proxy: 'memory',
                        fields: ['name', 'url', 'canRead']
                    }
                }],
                border: true,
                minHeight: 50,
                collapsed: true,
                header: {
                    listeners: {
                        click: function(header){
                            var panel = header.up('panel');
                            if (panel.collapsed)
                                panel.expand(Ext4.Component.DIRECTION_BOTTOM, true);
                            else
                                panel.collapse(Ext4.Component.DIRECTION_TOP, true);
                        }
                    }
                },
                listeners: {
                    collapse: function(panel){
                        LABKEY.HoverPopup._visiblePopup.extPopup.sync();
                    },
                    beforeexpand: function(panel){
                        this.up('#menuPanel').items.each(function(i){
                            if (i != panel){
                                i.collapse(Ext4.Component.DIRECTION_TOP, true);
                            }
                        }, this);
                    }
                }
            },
            items: [{
                title: 'EHR',
                itemId: 'ehr'
            },{
                itemId: 'admin',
                title: 'Admin'
            },{
                itemId: 'dcm',
                title: 'DCM'
            },{
                title: 'Labs',
                itemId: 'labs'
            },{
                title: 'Cores & Resources',
                itemId: 'cores'
            }]
        });
        panel.render(div.id);

        ONPRC.Utils.getNavItems({
            scope: this,
            success: function(results){
                Ext4.each(['labs', 'admin', 'cores', 'ehr', 'dcm'], function(name){
                    if (results[name] && results[name].length){
                        var section = panel.down('#' + name).items.get(0);
                        var toAdd = [];
                        Ext4.each(results[name], function(item){
                            toAdd.push(LDK.StoreUtils.createModelInstance(section.store, {
                                name: item.name,
                                url: item.canRead ? item.url : null,
                                canRead: item.canRead
                            }));
                        }, this);

                        if (toAdd.length)
                            section.store.add(toAdd);
                    }
                }, this);
            }
        });
    });

</script>